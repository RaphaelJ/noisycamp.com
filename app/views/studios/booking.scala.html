@* Noisycamp is a platform for booking music studios.
 * Copyright (C) 2019  Raphael Javaux <raphaeljavaux@gmail.com>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *@

@import play.api.Configuration
@import play.api.data.FormError
@import play.api.libs.json.Json
@import play.api.mvc.RequestHeader

@import misc.JsonWrites._

@(
    identity: models.Identity,
    owner: models.User, studio: models.Studio,
    pictures: Seq[models.Picture#Id],
    summary: Either[Seq[FormError], (models.BookingTimes, models.PriceBreakdown)])(
    implicit req: RequestHeader, config: Configuration, flash: Flash)

@leftPanel = {
    <div class="grid-y grid-padding-y">
        <div class="cell text-center hide-for-small-only">
            <reactive-picture
                alt="@{studio.name} picture"
                picture-id="@pictures.head.base64"
                :width="400"
                :height="225">
            </reactive-picture>
        </div>

        <div class="cell">
            <div class="grid-y">
                <div class="cell">
                    <a href="@routes.StudiosController.show(studio.id)">
                        ‚Üê Get back to studio page
                    </a>
                </div>

                <div class="cell">
                    <h4>@studio.name</h4>
                </div>
            </div>
        </div>
    </div>
}

@rightPanel = {
    @summary match {
        case Left(_) => {
            <div class="cell callout alert">
                <div class="grid-x grid-margin-x">
                    <div class="cell shrink text-center">
                        <i class="fi-alert" style="font-size: 4rem"></i>
                    </div>

                    <div class="cell auto">
                        <p>The studio cannot be reserved during the selected times.</p>

                        <p>
                            <a href="@routes.StudiosController.show(studio.id)">
                                Click here
                            </a>
                            to get back to the studio page.
                        </p>
                    </div>
                </div>
            </div>
        }
        case Right((bookingTimes, priceBreakdown)) => {
            <h3>Summary</h3>

            <div class="grid-y">
                <div class="cell">
                    <i class="fi-marker"></i>&nbsp;
                    @studio.location.address.city, @studio.location.address.country.name
                </div>

                <div class="cell">
                    <i class="fi-calendar"></i>&nbsp;
                    @tags.localDateTime(bookingTimes.beginsAt)
                </div>

                <div class="cell">
                    <i class="fi-clock"></i>&nbsp;
                    @tags.duration(bookingTimes.duration)
                </div>
            </div>

            <hr>

            <h3>Price breakdown</h3>

            @tags.priceBreakdown(priceBreakdown)

            <hr>

            @if(studio.canBeBooked(owner)) {
                @defining(studio.localPricingPolicy) { pricingPolicy =>
                    <booking-form
                        :studio-id='@studio.id'
                        :opening-schedule="@tags.json(Json.toJson(studio.openingSchedule), htmlEscape = true)"
                        :pricing-policy="@tags.json(Json.toJson(pricingPolicy), htmlEscape = true)"
                        :booking-times="@tags.json(Json.toJson(bookingTimes), htmlEscape = true)"
                        :has-online-payment='@{studio.paymentPolicy.hasOnlinePayment && owner.isPayoutSetup}'
                        :has-onsite-payment='@studio.paymentPolicy.hasOnsitePayment'
                        csrf-token="@helper.CSRF.getToken.value">
                    </booking-form>
                }
            } else {
                <div class="text-center">
                    This studio cannot be booked online.
                </div>
            }
        }
    }
}

@layout(Seq("Book music studio in " + studio.name), identity=Some(identity)) {

    <div class="grid-container">
        <div class="grid-x grid-padding-x grid-padding-y">
            <div class="cell">
                <h1>Booking review</h1>
            </div>

            <div class="cell small-12 medium-4">
                <div class="panel-section">
                    @leftPanel
                </div>
            </div>

            <div class="cell small-12 medium-8">
                <div class="grid-y grid-padding-y">

                    <div class="cell">
                        <div class="panel-section">
                            @rightPanel
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
